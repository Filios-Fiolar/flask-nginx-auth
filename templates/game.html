<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game</title>
    <style>
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; margin-top: 40px; }
        .container { display: flex; }
        .score-panel { margin-left: 30px; }
        table { border-collapse: collapse; }
        td {
            width: 60px;
            height: 60px;
            text-align: center;
            vertical-align: middle;
            font-size: 24px;
            cursor: pointer;
            border: 1px solid #ccc;
        }
        .selected { outline: 3px solid #f00; }
    </style>
</head>
<body>
<div class="container">
    <div>
        <h2>Игра 5x5</h2>
        <table id="board"></table>
    </div>
    <div class="score-panel">
        <h3>Очки: <span id="score">0</span></h3>
    </div>
</div>

<script>
let board = [];
let selected = null;
let score = 0;

function createBoard() {
    fetch("/api/new_board")
        .then(response => response.json())
        .then(data => {
            board = data.board;
            drawBoard();
        });
}

function drawBoard() {
    const table = document.getElementById("board");
    table.innerHTML = "";
    for (let i = 0; i < board.length; i++) {
        const row = table.insertRow();
        for (let j = 0; j < board[i].length; j++) {
            const cell = row.insertCell();
            cell.textContent = board[i][j];
            cell.dataset.row = i;
            cell.dataset.col = j;
            cell.onclick = handleClick;
            if (selected && selected.row == i && selected.col == j) {
                cell.classList.add("selected");
            }
        }
    }
}

function handleClick(event) {
    const row = parseInt(event.target.dataset.row);
    const col = parseInt(event.target.dataset.col);

    if (!selected) {
        selected = {row, col};
    } else {
        const dr = Math.abs(selected.row - row);
        const dc = Math.abs(selected.col - col);
        if ((dr === 1 && dc === 0) || (dr === 0 && dc === 1)) {
            swapAndCheck(selected, {row, col});
            selected = null;
        } else {
            selected = {row, col};
        }
    }
    drawBoard();
}

function swapAndCheck(a, b) {
    swap(a, b);
    if (hasMatches()) {
        resolveMatches();
    } else {
        setTimeout(() => {
            swap(a, b);
            drawBoard();
        }, 300);
    }
}

function swap(a, b) {
    [board[a.row][a.col], board[b.row][b.col]] = [board[b.row][b.col], board[a.row][a.col]];
}

function hasMatches() {
    for (let i = 0; i < 5; i++) {
        for (let j = 0; j < 3; j++) {
            let val = board[i][j];
            if (val && val === board[i][j+1] && val === board[i][j+2]) return true;
            val = board[j][i];
            if (val && val === board[j+1][i] && val === board[j+2][i]) return true;
        }
    }
    return false;
}

function resolveMatches() {
    let matched = false;

    // Горизонтально
    for (let i = 0; i < 5; i++) {
        for (let j = 0; j < 3; j++) {
            let val = board[i][j];
            if (val && val === board[i][j+1] && val === board[i][j+2]) {
                board[i][j] = board[i][j+1] = board[i][j+2] = 0;
                score += 100;
                matched = true;
            }
        }
    }

    // Вертикально
    for (let j = 0; j < 5; j++) {
        for (let i = 0; i < 3; i++) {
            let val = board[i][j];
            if (val && val === board[i+1][j] && val === board[i+2][j]) {
                board[i][j] = board[i+1][j] = board[i+2][j] = 0;
                score += 100;
                matched = true;
            }
        }
    }

    if (matched) {
        collapseBoard();
        drawBoard();
        document.getElementById("score").textContent = score;
        setTimeout(resolveMatches, 300);
    }
}

function collapseBoard() {
    for (let j = 0; j < 5; j++) {
        for (let i = 4; i >= 0; i--) {
            if (board[i][j] === 0) {
                for (let k = i - 1; k >= 0; k--) {
                    if (board[k][j] !== 0) {
                        board[i][j] = board[k][j];
                        board[k][j] = 0;
                        break;
                    }
                }
            }
        }
        for (let i = 0; i < 5; i++) {
            if (board[i][j] === 0) board[i][j] = Math.floor(Math.random() * 5) + 1;
        }
    }
}

createBoard();
</script>
</body>
</html>
